<!DOCTYPE html>
<html lang="en-US">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>A multi-path split relaying scheme based on SNI proxy - Trojan-Go Docs</title>
<meta name="description" content="An unidentifiable mechanism that helps you bypass GFW.">
<meta name="generator" content="Hugo 0.108.0">
<link href="https://azadzadeh.github.io/trojan-goindex.xml" rel="alternate" type="application/rss+xml">
<link rel="canonical" href="https://azadzadeh.github.io/trojan-go/en/advance/nginx-relay/">
<link rel="stylesheet" href="https://azadzadeh.github.io/trojan-go/css/theme.min.css">
<script src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
<link rel="stylesheet" href="https://azadzadeh.github.io/trojan-go/css/chroma.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js"></script>
<script src="https://azadzadeh.github.io/trojan-go/js/bundle.js"></script><style>
:root {}
</style>
<meta property="og:title" content="A multi-path split relaying scheme based on SNI proxy" />
<meta property="og:description" content="Preface Trojan is a tool for encrypted data transmission through TLS encapsulation. By using its TLS feature, we can achieve different paths of relaying on the same host port through SNI proxy.
Required tools and other preparations Relay machine: nginx version 1.11.5 and above Landing machine: trojan server (no version required) Configuration method For the sake of illustration, two relay hosts and two landing hosts are used here. The four hosts are bound to the domain name (a/b/c/d)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://azadzadeh.github.io/trojan-go/en/advance/nginx-relay/" /><meta property="og:image" content="https://azadzadeh.github.io/trojan-go/images/og-image.png"/><meta property="article:section" content="advance" />

<meta property="og:site_name" content="Trojan-Go Docs" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://azadzadeh.github.io/trojan-go/images/og-image.png"/>

<meta name="twitter:title" content="A multi-path split relaying scheme based on SNI proxy"/>
<meta name="twitter:description" content="Preface Trojan is a tool for encrypted data transmission through TLS encapsulation. By using its TLS feature, we can achieve different paths of relaying on the same host port through SNI proxy.
Required tools and other preparations Relay machine: nginx version 1.11.5 and above Landing machine: trojan server (no version required) Configuration method For the sake of illustration, two relay hosts and two landing hosts are used here. The four hosts are bound to the domain name (a/b/c/d)."/>
<meta itemprop="name" content="A multi-path split relaying scheme based on SNI proxy">
<meta itemprop="description" content="Preface Trojan is a tool for encrypted data transmission through TLS encapsulation. By using its TLS feature, we can achieve different paths of relaying on the same host port through SNI proxy.
Required tools and other preparations Relay machine: nginx version 1.11.5 and above Landing machine: trojan server (no version required) Configuration method For the sake of illustration, two relay hosts and two landing hosts are used here. The four hosts are bound to the domain name (a/b/c/d).">

<meta itemprop="wordCount" content="667"><meta itemprop="image" content="https://azadzadeh.github.io/trojan-go/images/og-image.png"/>
<meta itemprop="keywords" content="" /></head>
<body><div class="container"><header>
<h1>Trojan-Go Docs</h1>
<a href="https://github.com/p4gefau1t/trojan-go" class="github"><i class="fab fa-github"></i></a>
<p class="description">An unidentifiable mechanism that helps you bypass GFW.</p>

</header>
<div class="global-menu">
<nav>
<ul>
<li><a href="/trojan-go/en/">English (DeepL)</a></li>
<li><a href="/trojan-go/zh/">Chinese (original)</a></li>
<li><a href="https://github.com/p4gefau1t">GitHub</a></li></ul>
</nav>
</div>
<div class="content-container">
<main><h1>A multi-path split relaying scheme based on SNI proxy</h1>
<h2 id="preface">Preface</h2>
<p>Trojan is a tool for encrypted data transmission through TLS encapsulation. By using its TLS feature, we can achieve different paths of relaying on the same host port through SNI proxy.</p>
<h2 id="required-tools-and-other-preparations">Required tools and other preparations</h2>
<ul>
<li>Relay machine: nginx version 1.11.5 and above</li>
<li>Landing machine: trojan server (no version required)</li>
</ul>
<h2 id="configuration-method">Configuration method</h2>
<p>For the sake of illustration, two relay hosts and two landing hosts are used here.
The four hosts are bound to the domain name (a/b/c/d).example.com as shown in the figure.
There are 4 paths to each other. They are a-c, a-d, b-c, and b-d, respectively.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>                        +-----------------+           +--------------------+
</span></span><span style="display:flex;"><span>                        |                 +----------&gt;+                    |
</span></span><span style="display:flex;"><span>                        |   VPS RELAY A   |           |   VPS ENDPOINT C   |
</span></span><span style="display:flex;"><span>                  +----&gt;+                 |   +------&gt;+                    |
</span></span><span style="display:flex;"><span>                  |     |  a.example.com  |   |       |   c.example.com    |
</span></span><span style="display:flex;"><span>                  |     |                 +------+    |                    |
</span></span><span style="display:flex;"><span>  +----------+    |     +-----------------+   |  |    +--------------------+
</span></span><span style="display:flex;"><span>  |          |    |                           |  |
</span></span><span style="display:flex;"><span>  |  client  +----+                           |  |
</span></span><span style="display:flex;"><span>  |          |    |                           |  |
</span></span><span style="display:flex;"><span>  +----------+    |     +-----------------+   |  |    +--------------------+
</span></span><span style="display:flex;"><span>                  |     |                 |   |  |    |                    |
</span></span><span style="display:flex;"><span>                  |     |   VPS RELAY B   |   |  +---&gt;+   VPS ENDPOINT D   |
</span></span><span style="display:flex;"><span>                  +----&gt;+                 +---+       |                    |
</span></span><span style="display:flex;"><span>                        |  b.example.com  |           |   d.example.com    |
</span></span><span style="display:flex;"><span>                        |                 +----------&gt;+                    |
</span></span><span style="display:flex;"><span>                        +-----------------+           +--------------------+
</span></span></code></pre></div><h3 id="configure-path-domain-names-and-corresponding-certificates">Configure path domain names and corresponding certificates</h3>
<p>First we need to assign each path a separate domain name and make it resolve to the respective entry host.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>a-c.example.com CNAME a.example.com
</span></span><span style="display:flex;"><span>a-d.example.com CNAME a.example.com
</span></span><span style="display:flex;"><span>b-c.example.com CNAME b.example.com
</span></span><span style="display:flex;"><span>b-d.example.com CNAME b.example.com
</span></span></code></pre></div><p>Then we need to deploy certificates for all target paths on the landing host
HTTP authentication cannot be passed because the resolution record and the host IP do not match. Here it is recommended to use DNS authentication to issue certificates.
The specific DNS validation plugin needs to be chosen according to your domain DNS resolution host, here AWS Route 53 is used.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>certbot certonly --dns-route53 -d a-c.example.com -d b-c.example.com // on host C
</span></span><span style="display:flex;"><span>certbot certonly --dns-route53 -d a-d.example.com -d b-d.example.com // on host D
</span></span></code></pre></div><h3 id="configuring-sni-proxy">Configuring SNI proxy</h3>
<p>Here we use the ssl_preread module of nginx to implement the SNI proxy.
Please fix the nginx.conf file as follows after installing nginx.
Note that this is not an HTTP service, so please do not write it in the configuration of the virtual host.</p>
<p>The corresponding configuration for host A is given here, and the same for host B.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">stream</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">map</span> $ssl_preread_server_name $name {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">a-c.example.com</span> <span style="color:#e6db74">c.example.com</span>; <span style="color:#75715e"># Forward a-c path traffic to host C
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">a-d.example.com</span> <span style="color:#e6db74">d.example.com</span>; <span style="color:#75715e"># Forward a-d path traffic to host D
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># If you need to configure other services on this host that take up port 443 (such as web services and Trojan services)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># Please make those services listen on other local ports (4000 is used here)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e"># All TLS requests that do not match the SNI above will be forwarded to this port, remove this line if you don&#39;t need it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">default</span> localhost:<span style="color:#ae81ff">4000</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">default</span> localhost:<span style="color:#ae81ff">4000</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listen</span> <span style="color:#ae81ff">443</span>; <span style="color:#75715e"># listen on port 443
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">proxy_pass</span> $name;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ssl_preread</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ssl_preread</span> <span style="color:#66d9ef">on</span>; }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="configuring-the-landed-trojan-service">Configuring the landed Trojan service</h3>
<p>In the previous configuration we used a certificate to issue the domain names for all target paths, so here we can use a Trojan server to handle requests for all target paths.
The configuration of Trojan is no different from the usual configuration method, and an example is still provided here. Unrelated configuration has been omitted.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;run_type&#34;</span>: <span style="color:#e6db74">&#34;server&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;local_addr&#34;</span>: <span style="color:#e6db74">&#34;0.0.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;local_port&#34;</span>: <span style="color:#ae81ff">443</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;ssl&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;cert&#34;</span>: <span style="color:#e6db74">&#34;/path/to/certificate.crt&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;key&#34;</span>: <span style="color:#e6db74">&#34;/path/to/private.key&#34;</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Tip: If you need to use separate Trojan servers for different paths on the landed host (for example, if you need to access your own billing service), you can configure an SNI proxy on the landed machine and forward it to a different local Trojan server listening port. Since the configuration is basically the same as the process mentioned above, we will not repeat it here.</p>
<h2 id="summary">Summary</h2>
<p>With the configuration method described above, we can implement multi-entry, multi-exit, multi-stage trunking of Trojan traffic on a single port.
For multi-stage trunking, simply configure the SNI proxy on the intermediate nodes along the same lines.</p>
<div class="edit-meta">

<br><a href="https://github.com/p4gefau1t/trojan-go/docs/edit/master/content/advance/nginx-relay.md" class="edit-page"><i class="fas fa-pen-square"></i> Edit on GitHub</a></div><nav class="pagination"><a class="nav nav-prev" href="https://azadzadeh.github.io/trojan-go/en/advance/forward/" title="Tunnels and reverse proxies"><i class="fas fa-arrow-left" aria-hidden="true"></i> Prev - Tunnels and reverse proxies</a>
<a class="nav nav-next" href="https://azadzadeh.github.io/trojan-go/en/advance/plugin/" title="Using Shadowsocks Plugin/Pluggable Transport Layer">Next - Using Shadowsocks Plugin/Pluggable Transport Layer <i class="fas fa-arrow-right" aria-hidden="true"></i></a>
</nav><footer><p class="powered">Powered by <a href="https://gohugo.io">Hugo</a>. Theme by <a href="https://themes.gohugo.io/hugo-theme-techdoc/">TechDoc</a>. Designed by <a href="https://github.com/thingsym/hugo-theme-techdoc">Thingsym</a>.</p>
</footer>
</main><div class="sidebar">

<nav class="open-menu">
<ul>
<li class=""><a href="https://azadzadeh.github.io/trojan-go">Home</a></li>

<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/basic/">Basic Configuration</a>
  
<ul class="sub-menu">
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/basic/trojan/">Trojan fundamentals</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/basic/config/">Configuring Trojan-Go correctly</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/basic/full-config/">Full configuration file</a></li>
</ul>
  
</li>

<li class="parent"><a href="https://azadzadeh.github.io/trojan-go/en/advance/">Advanced Configuration</a>
  
<ul class="sub-menu">
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/advance/mux/">Enabling multiplexing to improve network concurrency performance</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/advance/websocket/">CDN forwarding and resisting man-in-the-middle attacks using Websocket</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/advance/router/">Domestic direct connection and ad blocking</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/advance/forward/">Tunnels and reverse proxies</a></li>
<li class="active"><a href="https://azadzadeh.github.io/trojan-go/en/advance/nginx-relay/">A multi-path split relaying scheme based on SNI proxy</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/advance/plugin/">Using Shadowsocks Plugin/Pluggable Transport Layer</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/advance/customize-protocol-stack/">Custom Protocol Stack</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/advance/aead/">Secondary encryption with Shadowsocks AEAD</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/advance/api/">Managing users dynamically using the API</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/advance/nat/">Transparent Proxy</a></li>
</ul>
  
</li>

<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/developer/">Implementation details and development guidelines</a>
  
<ul class="sub-menu">
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/developer/overview/">Basic introduction</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/developer/build/">Compiling and customizing Trojan-Go</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/developer/trojan/">Trojan Protocol</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/developer/mux/">Multiplexing</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/developer/websocket/">Websocket</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/developer/simplesocks/">SimpleSocks Protocol</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/developer/api/">API Development</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/developer/plugin/">Pluggable transport layer plug-in development</a></li>
<li class=""><a href="https://azadzadeh.github.io/trojan-go/en/developer/url/">URL scheme (draft)</a></li>
</ul>
  
</li>
</ul>
</nav>



<div class="sidebar-footer"></div>
</div>
</div><a href="#" id="backtothetop-fixed" class="backtothetop"
 data-backtothetop-duration="600"
 data-backtothetop-easing="easeOutQuart"
 data-backtothetop-fixed-fadeIn="1000"
 data-backtothetop-fixed-fadeOut="1000"
 data-backtothetop-fixed-bottom="10"
 data-backtothetop-fixed-right="20">
<span class="fa-layers fa-fw">
<i class="fas fa-circle"></i>
<i class="fas fa-arrow-circle-up"></i>
</span></a>
</div>
</body>
</html>
